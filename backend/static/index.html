<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bambu Batch Manager - è‡ªåŠ¨æ¢ç›˜ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
        :root {
            --el-color-primary: #009688; /* æ‹“ç«¹ç»¿é£æ ¼ */
        }
        body { 
            font-family: 'Inter', 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 0;
            color: #303133;
        }
        .app-header {
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 0 20px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-logo {
            font-size: 20px;
            font-weight: bold;
            color: var(--el-color-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .container { 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 0 20px;
        }
        .status-dashboard {
            margin-bottom: 24px;
        }
        .stat-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #909399;
        }
        .upload-zone {
            margin-bottom: 24px;
        }
        .task-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .task-card-item {
            margin-bottom: 16px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        .task-card-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .task-card-item.status-printing {
            border-left-color: var(--el-color-primary);
            background-color: #f0f9eb;
        }
        .thumbnail-box {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f7fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ebeef5;
        }
        .thumbnail-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .param-tag {
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .upload-dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .container { padding: 0 10px; }
            .el-col { margin-bottom: 12px; }
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <div class="app-logo">
                <el-icon><Printer /></el-icon>
                Bambu Batch Manager
            </div>
            <div>
                <el-button text @click="showPrinterMgr = true" style="margin-right: 15px">
                    <el-icon style="margin-right: 5px"><Setting /></el-icon> ç®¡ç†æ‰“å°æœº
                </el-button>
                <el-tag :type="schedulerRunning ? 'success' : 'danger'" effect="dark" round>
                    {{ schedulerRunning ? 'è°ƒåº¦è¿è¡Œä¸­' : 'è°ƒåº¦å·²æš‚åœ' }}
                </el-tag>
                <el-switch 
                    v-model="schedulerRunning" 
                    style="margin-left: 10px"
                    inline-prompt
                    active-text="ON"
                    inactive-text="OFF"
                    @change="toggleScheduler"
                ></el-switch>
            </div>
        </header>

        <div class="container">
            <!-- çŠ¶æ€ä»ªè¡¨ç›˜ -->
            <div class="status-dashboard">
                <el-empty v-if="status.printers.length === 0" description="æš‚æ— æ‰“å°æœºï¼Œè¯·åœ¨åå°æ·»åŠ "></el-empty>
                
                <el-row :gutter="20" v-for="printer in status.printers" :key="printer.serial_no" style="margin-bottom: 20px;">
                    <!-- æ‰“å°æœºçŠ¶æ€ -->
                    <el-col :xs="24" :sm="8">
                        <el-card shadow="hover" class="stat-card">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="stat-label">
                                    {{ printer.serial_no }} 
                                    <el-tag size="small" v-if="!printer.connected" type="danger">æ–­å¼€</el-tag>
                                </span>
                                <el-icon :size="20" color="#909399"><Monitor /></el-icon>
                            </div>
                            <div class="stat-value" :style="{ color: getStatusColor(printer.g_st) }">
                                {{ getPrinterStatusText(printer.g_st) }}
                            </div>
                            <div v-if="printer.is_cooling" style="font-size: 13px; color: #e6a23c; display: flex; align-items: center; gap: 4px;">
                                <el-icon class="is-loading"><Loading /></el-icon> æ¢ç›˜å†·å´ä¸­...
                            </div>
                            <div v-if="printer.error" style="font-size: 13px; color: #f56c6c;">
                                é”™è¯¯ç : {{ printer.error }}
                            </div>
                        </el-card>
                    </el-col>
                    <!-- è¿›åº¦ä¸æ¸©åº¦ -->
                    <el-col :xs="24" :sm="8">
                        <el-card shadow="hover" class="stat-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span class="stat-label">å®æ—¶ç›‘æ§</span>
                                <span style="font-weight: bold;">{{ printer.progress }}%</span>
                            </div>
                            <el-progress :percentage="printer.progress" :stroke-width="10" :show-text="false" :status="printer.g_st === 6 ? '' : 'success'"></el-progress>
                            <div style="margin-top: 15px; display: flex; justify-content: space-between; font-size: 13px; color: #606266;">
                                <span>ğŸŒ¡ï¸ å–·å¤´: <b>{{ printer.nozzle_temp }}Â°C</b></span>
                                <span>ğŸ”¥ çƒ­åºŠ: <b>{{ printer.bed_temp }}Â°C</b></span>
                            </div>
                        </el-card>
                    </el-col>
                    <!-- é˜Ÿåˆ—ç»Ÿè®¡ (å…¨å±€) -->
                    <el-col :xs="24" :sm="8" v-if="status.printers.indexOf(printer) === 0">
                        <el-card shadow="hover" class="stat-card">
                            <div class="stat-label">é˜Ÿåˆ—æ¦‚è§ˆ (æ€»è®¡)</div>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <div>
                                    <div class="stat-value" style="font-size: 20px;">{{ tasks.filter(t => t.status === 'pending').length }}</div>
                                    <div style="font-size: 12px; color: #909399;">ç­‰å¾…ä¸­</div>
                                </div>
                                <div>
                                    <div class="stat-value" style="font-size: 20px; color: #67C23A;">{{ tasks.filter(t => t.status === 'completed').length }}</div>
                                    <div style="font-size: 12px; color: #909399;">å·²å®Œæˆ</div>
                                </div>
                                <div>
                                    <div class="stat-value" style="font-size: 20px; color: #F56C6C;">{{ tasks.filter(t => t.status === 'failed').length }}</div>
                                    <div style="font-size: 12px; color: #909399;">å¤±è´¥</div>
                                </div>
                            </div>
                        </el-card>
                    </el-col>
                </el-row>
            </div>

            <!-- æ“ä½œæ  -->
            <div class="task-list-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <el-icon><List /></el-icon> ç”Ÿäº§é˜Ÿåˆ—
                </h2>
                <el-button type="primary" size="large" @click="showUploadDialog = true">
                    <el-icon style="margin-right: 5px"><Plus /></el-icon> æ–°å¢ä»»åŠ¡
                </el-button>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div v-if="tasks.length > 0">
                <el-card v-for="task in tasks" :key="task.id" 
                    class="task-card-item" 
                    :class="{ 'status-printing': task.status === 'printing' }"
                    :body-style="{ padding: '15px' }">
                    <el-row :gutter="20" align="middle">
                        <el-col :xs="8" :sm="3">
                            <div class="thumbnail-box">
                                <img :src="task.thumbnail_path || 'https://via.placeholder.com/100x100?text=No+Img'" loading="lazy">
                            </div>
                        </el-col>
                        <el-col :xs="16" :sm="15">
                            <h3 style="margin: 0 0 8px 0; font-size: 16px; word-break: break-all;">
                                {{ task.filename }}
                                <el-tag v-if="task.priority > 0" type="warning" size="small" effect="dark" style="margin-left: 5px;">
                                    Priority: {{ task.priority }}
                                </el-tag>
                            </h3>
                            <div style="color: #909399; font-size: 13px; margin-bottom: 8px;">
                                <el-icon style="vertical-align: -1px"><Clock /></el-icon> {{ new Date(task.created_at).toLocaleString() }}
                                <span v-if="task.completed_at"> Â· å®Œæˆäº {{ new Date(task.completed_at).toLocaleTimeString() }}</span>
                            </div>
                            <div>
                                <el-tag size="small" effect="plain" class="param-tag" v-if="task.bed_levelling">çƒ­åºŠè°ƒå¹³</el-tag>
                                <el-tag size="small" effect="plain" class="param-tag" v-if="task.flow_cali">æµé‡æ ¡å‡†</el-tag>
                                <el-tag size="small" effect="plain" class="param-tag" v-if="task.use_ams">AMS</el-tag>
                                <el-tag size="small" effect="plain" class="param-tag" v-if="task.timelapse">å»¶æ—¶æ‘„å½±</el-tag>
                            </div>
                        </el-col>
                        <el-col :xs="24" :sm="6" style="text-align: right; margin-top: 10px;">
                            <el-tag :type="getTaskStatusType(task.status)" size="large" effect="dark" style="margin-right: 10px;">
                                {{ getTaskStatusText(task.status) }}
                            </el-tag>
                            
                            <!-- æ“ä½œæŒ‰é’®ç»„ -->
                            <el-button-group style="margin-right: 10px;">
                                <el-tooltip content="ç½®é¡¶æ’é˜Ÿ" v-if="task.status === 'pending'">
                                    <el-button type="warning" icon="Top" plain circle @click="prioritizeTask(task.id)"></el-button>
                                </el-tooltip>
                                <el-tooltip content="é‡è¯•ä»»åŠ¡" v-if="task.status === 'failed' || task.status === 'completed'">
                                    <el-button type="success" icon="RefreshRight" plain circle @click="retryTask(task.id)"></el-button>
                                </el-tooltip>
                            </el-button-group>

                            <el-popconfirm 
                                title="ç¡®å®šåˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ" 
                                @confirm="deleteTask(task.id)"
                                v-if="['pending', 'failed', 'completed'].includes(task.status)"
                            >
                                <template #reference>
                                    <el-button type="danger" icon="Delete" circle plain></el-button>
                                </template>
                            </el-popconfirm>
                        </el-col>
                    </el-row>
                </el-card>
            </div>
            <el-empty v-else description="é˜Ÿåˆ—ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»æ·»åŠ ä»»åŠ¡å§ï¼"></el-empty>
        </div>

        <!-- ä¸Šä¼ å¼¹çª— -->
        <el-dialog v-model="showUploadDialog" title="ä¸Šä¼ æ‰“å°æ–‡ä»¶ (.3mf)" width="500px" destroy-on-close>
            <el-upload
                class="upload-demo"
                drag
                action=""
                :auto-upload="false"
                :on-change="handleFileChange"
                :show-file-list="false"
                accept=".3mf"
            >
                <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                <div class="el-upload__text">
                    æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ– <em>ç‚¹å‡»ä¸Šä¼ </em>
                    <div v-if="selectedFile" style="margin-top: 10px; color: var(--el-color-primary); font-weight: bold;">
                        å·²é€‰æ‹©: {{ selectedFile.name }}
                    </div>
                </div>
            </el-upload>
            
            <div style="margin-top: 20px;">
                <div style="font-weight: bold; margin-bottom: 10px;">æ‰“å°å‚æ•°è¦†ç›–</div>
                <el-row :gutter="20">
                    <el-col :span="12"><el-checkbox v-model="uploadParams.bed_levelling" label="çƒ­åºŠè°ƒå¹³" border style="width: 100%" /></el-col>
                    <el-col :span="12"><el-checkbox v-model="uploadParams.flow_cali" label="æµé‡æ ¡å‡†" border style="width: 100%" /></el-col>
                </el-row>
                <el-row :gutter="20" style="margin-top: 10px;">
                    <el-col :span="12"><el-checkbox v-model="uploadParams.use_ams" label="ä½¿ç”¨ AMS" border style="width: 100%" /></el-col>
                    <el-col :span="12"><el-checkbox v-model="uploadParams.timelapse" label="å»¶æ—¶æ‘„å½±" border style="width: 100%" /></el-col>
                </el-row>
                
                <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 14px;">é‡å¤æ¬¡æ•°:</span>
                    <el-input-number v-model="uploadParams.repeat_count" :min="1" :max="50" style="width: 120px;" />
                    <span style="font-size: 12px; color: #909399;">(è‡ªåŠ¨åˆ›å»ºå¤šæ¡ä»»åŠ¡)</span>
                </div>
            </div>

            <template #footer>
                <div class="upload-dialog-footer">
                    <el-button @click="showUploadDialog = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="uploadTask" :loading="uploading" :disabled="!selectedFile">
                        ç¡®è®¤æ·»åŠ åˆ°é˜Ÿåˆ—
                    </el-button>
                </div>
            </template>
        </el-dialog>

        <!-- æ‰“å°æœºç®¡ç†å¼¹çª— -->
        <el-dialog v-model="showPrinterMgr" title="æ‰“å°æœºç®¡ç†" width="700px">
            <el-table :data="status.printers" style="width: 100%; margin-bottom: 20px;" border>
                <el-table-column prop="name" label="åç§°" width="120"></el-table-column>
                <el-table-column prop="ip" label="IPåœ°å€" width="130"></el-table-column>
                <el-table-column prop="serial_no" label="åºåˆ—å·" width="180"></el-table-column>
                <el-table-column label="çŠ¶æ€" width="100">
                    <template #default="scope">
                        <el-tag :type="scope.row.connected ? 'success' : 'danger'" size="small">
                            {{ scope.row.connected ? 'åœ¨çº¿' : 'ç¦»çº¿' }}
                        </el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" fixed="right" min-width="100">
                    <template #default="scope">
                        <el-popconfirm title="ç¡®å®šåˆ é™¤è¿™å°æ‰“å°æœºå—ï¼Ÿ" @confirm="deletePrinter(scope.row.id)">
                            <template #reference>
                                <el-button type="danger" size="small" link>åˆ é™¤</el-button>
                            </template>
                        </el-popconfirm>
                    </template>
                </el-table-column>
            </el-table>

            <el-divider content-position="left">æ·»åŠ æ–°æ‰“å°æœº</el-divider>

            <el-form :model="newPrinter" label-width="100px" :inline="true" size="small">
                <el-form-item label="åç§°">
                    <el-input v-model="newPrinter.name" placeholder="å¦‚: 1å·æœº"></el-input>
                </el-form-item>
                <el-form-item label="IPåœ°å€">
                    <el-input v-model="newPrinter.ip" placeholder="192.168.x.x"></el-input>
                </el-form-item>
                <el-form-item label="åºåˆ—å·">
                    <el-input v-model="newPrinter.serial_no" placeholder="æœºå™¨SNç "></el-input>
                </el-form-item>
                <el-form-item label="è®¿é—®ç ">
                    <el-input v-model="newPrinter.access_code" placeholder="Access Code"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" @click="addPrinter">æ·»åŠ </el-button>
                </el-form-item>
            </el-form>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, onMounted, reactive } = Vue;
        const { ElMessage } = ElementPlus;
        
        const app = createApp({
            setup() {
                const status = reactive({
                    printers: [],
                    scheduler: 'paused'
                });
                const tasks = ref([]);
                const schedulerRunning = ref(false);
                const showUploadDialog = ref(false);
                const showPrinterMgr = ref(false);
                const selectedFile = ref(null);
                const uploading = ref(false);
                const uploadParams = reactive({
                    bed_levelling: true,
                    flow_cali: true,
                    timelapse: false,
                    use_ams: false,
                    repeat_count: 1
                });
                const newPrinter = reactive({
                    name: '', ip: '', serial_no: '', access_code: ''
                });

                // è·å–æ•°æ®
                const fetchData = async () => {
                    try {
                        const [statusRes, tasksRes] = await Promise.all([
                            axios.get('/status'),
                            axios.get('/tasks')
                        ]);
                        status.printers = statusRes.data.printers;
                        status.scheduler = statusRes.data.scheduler;
                        schedulerRunning.value = status.scheduler === 'running';
                        tasks.value = tasksRes.data;
                    } catch (e) {
                        console.error('Data fetch error:', e);
                    }
                };

                onMounted(() => {
                    fetchData();
                    // è½®è¯¢ (3s)
                    setInterval(fetchData, 3000);
                });

                const toggleScheduler = async (val) => {
                    const action = val ? 'resume' : 'pause';
                    try {
                        await axios.post(`/control/${action}`);
                        ElMessage.success(val ? 'è°ƒåº¦å·²å¯åŠ¨' : 'è°ƒåº¦å·²æš‚åœ');
                        fetchData();
                    } catch (e) {
                        ElMessage.error('æ“ä½œå¤±è´¥');
                        schedulerRunning.value = !val; // å›æ»š
                    }
                };

                const handleFileChange = (file) => {
                    if (file.raw.name.endsWith('.3mf')) {
                        selectedFile.value = file.raw;
                    } else {
                        ElMessage.warning('ä»…æ”¯æŒ .3mf æ–‡ä»¶');
                    }
                };

                const uploadTask = async () => {
                    if (!selectedFile.value) return;
                    
                    const formData = new FormData();
                    formData.append('file', selectedFile.value);
                    Object.keys(uploadParams).forEach(key => {
                        formData.append(key, uploadParams[key]);
                    });

                    uploading.value = true;
                    try {
                        await axios.post('/upload', formData);
                        ElMessage.success('ä»»åŠ¡å·²æ·»åŠ ');
                        selectedFile.value = null;
                        showUploadDialog.value = false;
                        fetchData();
                    } catch (e) {
                        ElMessage.error('ä¸Šä¼ å¤±è´¥: ' + (e.response?.data?.detail || e.message));
                    } finally {
                        uploading.value = false;
                    }
                };

                const deleteTask = async (id) => {
                    try {
                        await axios.delete(`/tasks/${id}`);
                        ElMessage.success('å·²åˆ é™¤');
                        fetchData();
                    } catch (e) {
                        ElMessage.error('åˆ é™¤å¤±è´¥');
                    }
                };

                const retryTask = async (id) => {
                    try {
                        await axios.post(`/tasks/${id}/retry`);
                        ElMessage.success('å·²é‡ç½®ä»»åŠ¡çŠ¶æ€');
                        fetchData();
                    } catch (e) {
                        ElMessage.error('æ“ä½œå¤±è´¥');
                    }
                };

                const prioritizeTask = async (id) => {
                    try {
                        await axios.patch(`/tasks/${id}`, { priority: 10 });
                        ElMessage.success('å·²æ’é˜Ÿç½®é¡¶');
                        fetchData();
                    } catch (e) {
                        ElMessage.error('æ“ä½œå¤±è´¥');
                    }
                };
                
                const addPrinter = async () => {
                    if(!newPrinter.ip || !newPrinter.access_code) return ElMessage.warning('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                    try {
                        await axios.post('/printers', newPrinter);
                        ElMessage.success('æ·»åŠ æˆåŠŸ');
                        // æ¸…ç©ºè¡¨å•
                        Object.assign(newPrinter, { name: '', ip: '', serial_no: '', access_code: '' });
                        fetchData();
                    } catch (e) {
                        ElMessage.error('æ·»åŠ å¤±è´¥: ' + (e.response?.data?.detail || e.message));
                    }
                };

                const deletePrinter = async (id) => {
                    try {
                        await axios.delete(`/printers/${id}`);
                        ElMessage.success('åˆ é™¤æˆåŠŸ');
                        fetchData();
                    } catch (e) {
                        ElMessage.error('åˆ é™¤å¤±è´¥');
                    }
                };

                // çŠ¶æ€æ˜ å°„
                const getPrinterStatusText = (st) => {
                    const map = {
                        '-1': 'æœªçŸ¥ / è¿æ¥ä¸­', 0: 'ç¦»çº¿', 1: 'ç©ºé—² (Ready)', 
                        2: 'å‡†å¤‡ä¸­', 3: 'æ‰“å°ä¸­', 4: 'æš‚åœ', 
                        5: 'å®Œæˆ', 6: 'æ‰“å°ä¸­', 100: 'å·²å®Œæˆ (å¾…æ¸…ç†)'
                    };
                    return map[st] || `æœªçŸ¥çŠ¶æ€ (${st})`;
                };

                const getStatusColor = (st) => {
                    if (st === 1) return '#67C23A'; // Green
                    if (st === 6 || st === 2 || st === 3) return '#409EFF'; // Blue
                    return '#909399'; // Gray
                };

                const getTaskStatusText = (st) => {
                    const map = { 'pending': 'ç­‰å¾…ä¸­', 'printing': 'æ‰“å°ä¸­', 'completed': 'å·²å®Œæˆ', 'failed': 'å¤±è´¥' };
                    return map[st] || st;
                };

                const getTaskStatusType = (st) => {
                    const map = { 'pending': 'info', 'printing': 'primary', 'completed': 'success', 'failed': 'danger' };
                    return map[st] || 'info';
                };

                return {
                    status, tasks, schedulerRunning, showUploadDialog, showPrinterMgr, selectedFile, uploading, uploadParams, newPrinter,
                    toggleScheduler, handleFileChange, uploadTask, deleteTask, retryTask, prioritizeTask, addPrinter, deletePrinter,
                    getPrinterStatusText, getStatusColor, getTaskStatusText, getTaskStatusType
                };
            }
        });

        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.mount('#app');
    </script>
</body>
</html>
